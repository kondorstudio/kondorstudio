# ================================================
# KONDOR STUDIO ‚Äî RENDER CONFIG (API + WORKER + FRONT)
# ================================================

services:
  # -----------------------------
  # üü£ API EXPRESS (BACKEND)
  # -----------------------------
  - type: web
    name: kondor-api
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: |
      npm install
      npm run deploy:migrate

    startCommand: npm start

    envVars:
      NODE_ENV: production
      PORT: 4000

      # === DATABASE + REDIS ===
      DATABASE_URL:
        fromDatabase:
          name: kondor-db
          property: connectionString
      REDIS_URL:
        fromService:
          name: kondor-redis
          property: connectionString

      # === JWT ===
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}

      # === CORS ===
      CORS_ORIGIN: ${CORS_ORIGIN}
      PUBLIC_APP_URL: ${PUBLIC_APP_URL}
      APPROVAL_PUBLIC_LINK_TTL_HOURS: ${APPROVAL_PUBLIC_LINK_TTL_HOURS}

      # === S3 ===
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}

      # === PROVIDER WHATSAPP ===
      WHATSAPP_API_URL: ${WHATSAPP_API_URL}
      WHATSAPP_API_KEY: ${WHATSAPP_API_KEY}
      WHATSAPP_FROM_NUMBER: ${WHATSAPP_FROM_NUMBER}
      WHATSAPP_TIMEOUT_MS: ${WHATSAPP_TIMEOUT_MS}

      # === META (FACEBOOK) ===
      META_GRAPH_BASE_URL: ${META_GRAPH_BASE_URL}
      META_DEFAULT_FIELDS: ${META_DEFAULT_FIELDS}

      # === GOOGLE ADS ===
      GOOGLE_ADS_API_BASE_URL: ${GOOGLE_ADS_API_BASE_URL}
      GOOGLE_ADS_DEFAULT_FIELDS: ${GOOGLE_ADS_DEFAULT_FIELDS}

      # === AUDIT LOG (FASE 5) ===
      AUDIT_LOG_ENABLED: ${AUDIT_LOG_ENABLED}
      AUDITLOG_SKIP_REGEX: ${AUDITLOG_SKIP_REGEX}
      AUDITLOG_BODY_MAX: ${AUDITLOG_BODY_MAX}

      # === CHECK SUBSCRIPTION (FASE 5) ===
      CHECK_SUBSCRIPTION_ENABLED: ${CHECK_SUBSCRIPTION_ENABLED}

      # === WORKERS ‚Äî INTERVALOS ===
      WORKER_POLL_INTERVAL: ${WORKER_POLL_INTERVAL}
      WORKER_MAX_ATTEMPTS: ${WORKER_MAX_ATTEMPTS}
      METRICS_AGG_PERIOD_MS: ${METRICS_AGG_PERIOD_MS}
      REPORTS_GENERATION_PERIOD_MS: ${REPORTS_GENERATION_PERIOD_MS}
      WHATSAPP_AUTOMATION_PERIOD_MS: ${WHATSAPP_AUTOMATION_PERIOD_MS}
      METRICS_BACKOFF_MS: ${METRICS_BACKOFF_MS}
      REPORT_BACKOFF_MS: ${REPORT_BACKOFF_MS}
      WHATSAPP_BACKOFF_MS: ${WHATSAPP_BACKOFF_MS}

    healthCheckPath: /healthz

  # -----------------------------
  # üü° WORKER ‚Äî BULLMQ / JOBS
  # -----------------------------
  - type: worker
    name: kondor-worker
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: npm install
    startCommand: npm run worker

    envVars:
      NODE_ENV: production
      DATABASE_URL:
        fromDatabase:
          name: kondor-db
          property: connectionString
      REDIS_URL:
        fromService:
          name: kondor-redis
          property: connectionString

      # Workers usam as mesmas vari√°veis da API
      WORKER_POLL_INTERVAL: ${WORKER_POLL_INTERVAL}
      WORKER_MAX_ATTEMPTS: ${WORKER_MAX_ATTEMPTS}
      METRICS_AGG_PERIOD_MS: ${METRICS_AGG_PERIOD_MS}
      REPORTS_GENERATION_PERIOD_MS: ${REPORTS_GENERATION_PERIOD_MS}
      WHATSAPP_AUTOMATION_PERIOD_MS: ${WHATSAPP_AUTOMATION_PERIOD_MS}
      METRICS_BACKOFF_MS: ${METRICS_BACKOFF_MS}
      REPORT_BACKOFF_MS: ${REPORT_BACKOFF_MS}
      WHATSAPP_BACKOFF_MS: ${WHATSAPP_BACKOFF_MS}

  # -----------------------------
  # üü© SPA FRONTEND (VITE ‚Üí DIST)
  # -----------------------------
  - type: static
    name: kondor-front
    rootDir: ./front

    buildCommand: |
      npm install
      npm run build

    staticPublishPath: ./dist

    # SPA fallback (Render recomenda configurar via dashboard,
    # mas deixamos aqui como documenta√ß√£o expl√≠cita)
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

# -----------------------------
# üóÑÔ∏è DATABASE (POSTGRES)
# -----------------------------
databases:
  - name: kondor-db
    region: oregon

# -----------------------------
# üî• REDIS (RATE LIMIT / BULLMQ)
# -----------------------------
# Pode ser Redis Standard ou Redis Lite.
# BullMQ funciona nas duas vers√µes.
# -----------------------------
services:
  - name: kondor-redis
    type: redis
    plan: starter
