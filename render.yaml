# ================================================
# KONDOR STUDIO ‚Äî RENDER CONFIG (API + WORKER + FRONT)
# ================================================

services:
  # -----------------------------
  # üü£ API EXPRESS (BACKEND)
  # -----------------------------
  - type: web
    name: kondor-api
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: |
      npm install
      npm run deploy:migrate

    startCommand: npm start

    envVars:
      - key: NODE_ENV
        value: production

      - key: PORT
        value: "4000"

      # ==== DATABASE + REDIS ====
      - key: DATABASE_URL
        fromDatabase:
          name: kondor-db
          property: connectionString

      - key: REDIS_URL
        fromService:
          type: redis
          name: kondor-redis
          property: connectionString

      # ==== JWT ====
      - key: JWT_SECRET
        sync: false
      - key: JWT_REFRESH_SECRET
        sync: false

      # ==== CORS / URLS ====
      - key: CORS_ORIGIN
        sync: false
      - key: PUBLIC_APP_URL
        sync: false
      - key: APPROVAL_PUBLIC_LINK_TTL_HOURS
        sync: false

      # ==== S3 ====
      - key: S3_ENDPOINT
        sync: false
      - key: S3_BUCKET
        sync: false
      - key: S3_ACCESS_KEY_ID
        sync: false
      - key: S3_SECRET_ACCESS_KEY
        sync: false

    healthCheckPath: /healthz

  # -----------------------------
  # üü° WORKER ‚Äî BULLMQ / JOBS
  # -----------------------------
  - type: worker
    name: kondor-worker
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: npm install
    startCommand: npm run worker

    envVars:
      - key: NODE_ENV
        value: production

      - key: DATABASE_URL
        fromDatabase:
          name: kondor-db
          property: connectionString

      - key: REDIS_URL
        fromService:
          type: redis
          name: kondor-redis
          property: connectionString

  # -----------------------------
  # üü© SPA FRONTEND (VITE)
  # -----------------------------
  - type: web
    name: kondor-front
    env: node
    rootDir: ./front
    plan: starter
    region: oregon

    buildCommand: |
      npm install
      npm run build

    startCommand: |
      npm install -g serve
      serve -s dist -l 3000

    envVars:
      - key: NODE_ENV
        value: production

  # -----------------------------
  # üî• REDIS (BULLMQ)
  # -----------------------------
  - type: redis
    name: kondor-redis
    plan: starter
    region: oregon
    ipAllowList: []

# -----------------------------
# üóÑÔ∏è DATABASE (POSTGRES)
# -----------------------------
databases:
  - name: kondor-db
    region: oregon
    plan: starter
