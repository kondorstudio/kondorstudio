# ================================================
# KONDOR STUDIO ‚Äî RENDER CONFIG (API + WORKER + FRONT)
# ================================================

services:
  # -----------------------------
  # üü£ API EXPRESS (BACKEND)
  # -----------------------------
  - type: web
    name: kondor-api
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: |
      npm install
      npm run deploy:migrate
      npm run prisma:generate

    startCommand: npm start

    envVars:
      - key: NODE_ENV
        value: production

      - key: NODE_VERSION
        value: "18"

      - key: PORT
        value: 4000

      # ==== DATABASE + REDIS ====
      - key: DATABASE_URL
        fromDatabase:
          name: kondor-db
          property: connectionString

      - key: REDIS_URL
        fromService:
          type: redis
          name: kondor-redis
          property: connectionString

      # ==== JWT ====
      - key: JWT_SECRET
        sync: false
      - key: JWT_REFRESH_SECRET
        sync: false

      # ==== CORS / URLS ====
      - key: CORS_ORIGIN
        sync: false
      - key: CORS_ORIGINS
        sync: false
      - key: CORS_ALLOW_ALL
        sync: false
      - key: PUBLIC_APP_URL
        sync: false
      - key: APPROVAL_PUBLIC_LINK_TTL_HOURS
        sync: false
      - key: APP_URL_FRONT
        sync: false
      - key: API_URL
        sync: false

      # ==== GA4 / GOOGLE OAUTH ====
      - key: GOOGLE_OAUTH_CLIENT_ID
        sync: false
      - key: GOOGLE_OAUTH_CLIENT_SECRET
        sync: false
      - key: GOOGLE_OAUTH_REDIRECT_URI
        sync: false
      - key: GOOGLE_OAUTH_SCOPES
        sync: false
      - key: ENCRYPTION_KEY
        sync: false
      - key: GA4_MOCK_MODE
        sync: false
      - key: GA4_REDIS_DISABLED
        sync: false
      - key: GA4_REDIS_URL
        sync: false
      - key: GA4_CONCURRENCY_TTL_MS
        sync: false
      - key: GA4_CONCURRENCY_WAIT_MS
        sync: false

      # ==== S3 ====
      - key: S3_ENDPOINT
        sync: false
      - key: S3_BUCKET
        sync: false
      - key: S3_ACCESS_KEY_ID
        sync: false
      - key: S3_SECRET_ACCESS_KEY
        sync: false

      # ==== WHATSAPP ====
      - key: WHATSAPP_API_URL
        sync: false
      - key: WHATSAPP_API_KEY
        sync: false
      - key: WHATSAPP_FROM_NUMBER
        sync: false
      - key: WHATSAPP_TIMEOUT_MS
        sync: false
      - key: WHATSAPP_PROVIDER
        sync: false
      - key: WHATSAPP_TOKEN
        sync: false
      - key: WHATSAPP_VERIFY_TOKEN
        sync: false
      - key: WHATSAPP_PHONE_NUMBER_ID
        sync: false
      - key: WHATSAPP_WABA_ID
        sync: false
      - key: WHATSAPP_META_TOKEN
        sync: false
      - key: WHATSAPP_META_PHONE_NUMBER_ID
        sync: false

      # ==== M√âTRICAS ====
      - key: META_GRAPH_BASE_URL
        sync: false
      - key: META_DEFAULT_FIELDS
        sync: false
      - key: GOOGLE_ADS_API_BASE_URL
        sync: false
      - key: GOOGLE_ADS_DEFAULT_FIELDS
        sync: false

      # ==== AUDIT LOG ====
      - key: AUDIT_LOG_ENABLED
        sync: false
      - key: AUDITLOG_SKIP_REGEX
        sync: false
      - key: AUDITLOG_BODY_MAX
        sync: false

      # ==== BILLING ====
      - key: CHECK_SUBSCRIPTION_ENABLED
        sync: false

      # ==== WORKER SETTINGS (COMPARTILHADAS) ====
      - key: WORKER_POLL_INTERVAL
        sync: false
      - key: WORKER_MAX_ATTEMPTS
        sync: false
      - key: METRICS_AGG_PERIOD_MS
        sync: false
      - key: REPORTS_GENERATION_PERIOD_MS
        sync: false
      - key: WHATSAPP_AUTOMATION_PERIOD_MS
        sync: false
      - key: METRICS_BACKOFF_MS
        sync: false
      - key: REPORT_BACKOFF_MS
        sync: false
      - key: WHATSAPP_BACKOFF_MS
        sync: false

    healthCheckPath: /healthz

  # -----------------------------
  # üü° WORKER ‚Äî BULLMQ / JOBS
  # -----------------------------
  - type: worker
    name: kondor-worker
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: |
      npm install
      npm run prisma:generate
    startCommand: npm run worker

    envVars:
      - key: NODE_ENV
        value: production

      - key: NODE_VERSION
        value: "18"

      - key: DATABASE_URL
        fromDatabase:
          name: kondor-db
          property: connectionString

      - key: REDIS_URL
        fromService:
          type: redis
          name: kondor-redis
          property: connectionString

      # ==== WORKER SETTINGS ====
      - key: WORKER_POLL_INTERVAL
        sync: false
      - key: WORKER_MAX_ATTEMPTS
        sync: false
      - key: METRICS_AGG_PERIOD_MS
        sync: false
      - key: REPORTS_GENERATION_PERIOD_MS
        sync: false
      - key: WHATSAPP_AUTOMATION_PERIOD_MS
        sync: false
      - key: METRICS_BACKOFF_MS
        sync: false
      - key: REPORT_BACKOFF_MS
        sync: false
      - key: WHATSAPP_BACKOFF_MS
        sync: false

      # ==== WHATSAPP ====
      - key: WHATSAPP_API_URL
        sync: false
      - key: WHATSAPP_API_KEY
        sync: false
      - key: WHATSAPP_FROM_NUMBER
        sync: false
      - key: WHATSAPP_TIMEOUT_MS
        sync: false
      - key: WHATSAPP_PROVIDER
        sync: false
      - key: WHATSAPP_TOKEN
        sync: false
      - key: WHATSAPP_VERIFY_TOKEN
        sync: false
      - key: WHATSAPP_PHONE_NUMBER_ID
        sync: false
      - key: WHATSAPP_WABA_ID
        sync: false
      - key: WHATSAPP_META_TOKEN
        sync: false
      - key: WHATSAPP_META_PHONE_NUMBER_ID
        sync: false

      # ==== M√âTRICAS ====
      - key: META_GRAPH_BASE_URL
        sync: false
      - key: META_DEFAULT_FIELDS
        sync: false
      - key: GOOGLE_ADS_API_BASE_URL
        sync: false
      - key: GOOGLE_ADS_DEFAULT_FIELDS
        sync: false

  # -----------------------------
  # üü© SPA FRONTEND (VITE)
  # -----------------------------
  - type: web
    name: kondor-front
    env: node
    rootDir: ./front
    plan: starter
    region: oregon

    buildCommand: |
      # garante que devDependencies (vite) sejam instaladas mesmo com NODE_ENV=production
      npm install --include=dev
      npm run build

    startCommand: |
      npm install -g serve
      serve -s dist -l 3000

    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: "18"
      # for√ßa instalar devDependencies (onde est√° o vite) caso Render respeite esse env no runtime
      - key: NPM_CONFIG_PRODUCTION
        value: "false"
      # URL da API usada pelo frontend (Vite)
      - key: VITE_API_URL
        sync: false

  # -----------------------------
  # üî• REDIS (BULLMQ)
  # -----------------------------
  - type: redis
    name: kondor-redis
    plan: starter
    region: oregon
    ipAllowList: []

# -----------------------------
# üóÑÔ∏è DATABASE (POSTGRES)
# -----------------------------
databases:
  - name: kondor-db
    region: oregon
    plan: free
