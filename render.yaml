# ================================================
# KONDOR STUDIO ‚Äî RENDER CONFIG (API + WORKER + FRONT)
# ================================================

services:
  # -----------------------------
  # üü£ API EXPRESS (BACKEND)
  # -----------------------------
  - type: web
    name: kondor-api
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: |
      npm install
      npm run deploy:migrate

    startCommand: npm start

    envVars:
      NODE_ENV: production
      PORT: 4000

      DATABASE_URL:
        fromDatabase:
          name: kondor-db
          property: connectionString

      REDIS_URL:
        fromService:
          name: kondor-redis
          property: connectionString

      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}

      CORS_ORIGIN: ${CORS_ORIGIN}
      PUBLIC_APP_URL: ${PUBLIC_APP_URL}
      APPROVAL_PUBLIC_LINK_TTL_HOURS: ${APPROVAL_PUBLIC_LINK_TTL_HOURS}

      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}

      WHATSAPP_API_URL: ${WHATSAPP_API_URL}
      WHATSAPP_API_KEY: ${WHATSAPP_API_KEY}
      WHATSAPP_FROM_NUMBER: ${WHATSAPP_FROM_NUMBER}
      WHATSAPP_TIMEOUT_MS: ${WHATSAPP_TIMEOUT_MS}

      META_GRAPH_BASE_URL: ${META_GRAPH_BASE_URL}
      META_DEFAULT_FIELDS: ${META_DEFAULT_FIELDS}

      GOOGLE_ADS_API_BASE_URL: ${GOOGLE_ADS_API_BASE_URL}
      GOOGLE_ADS_DEFAULT_FIELDS: ${GOOGLE_ADS_DEFAULT_FIELDS}

      AUDIT_LOG_ENABLED: ${AUDIT_LOG_ENABLED}
      AUDITLOG_SKIP_REGEX: ${AUDITLOG_SKIP_REGEX}
      AUDITLOG_BODY_MAX: ${AUDITLOG_BODY_MAX}

      CHECK_SUBSCRIPTION_ENABLED: ${CHECK_SUBSCRIPTION_ENABLED}

      WORKER_POLL_INTERVAL: ${WORKER_POLL_INTERVAL}
      WORKER_MAX_ATTEMPTS: ${WORKER_MAX_ATTEMPTS}
      METRICS_AGG_PERIOD_MS: ${METRICS_AGG_PERIOD_MS}
      REPORTS_GENERATION_PERIOD_MS: ${REPORTS_GENERATION_PERIOD_MS}
      WHATSAPP_AUTOMATION_PERIOD_MS: ${WHATSAPP_AUTOMATION_PERIOD_MS}
      METRICS_BACKOFF_MS: ${METRICS_BACKOFF_MS}
      REPORT_BACKOFF_MS: ${REPORT_BACKOFF_MS}
      WHATSAPP_BACKOFF_MS: ${WHATSAPP_BACKOFF_MS}

    healthCheckPath: /healthz

  # -----------------------------
  # üü° WORKER ‚Äî BULLMQ / JOBS
  # -----------------------------
  - type: worker
    name: kondor-worker
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: npm install
    startCommand: npm run worker

    envVars:
      NODE_ENV: production
      DATABASE_URL:
        fromDatabase:
          name: kondor-db
          property: connectionString

      REDIS_URL:
        fromService:
          name: kondor-redis
          property: connectionString

      WORKER_POLL_INTERVAL: ${WORKER_POLL_INTERVAL}
      WORKER_MAX_ATTEMPTS: ${WORKER_MAX_ATTEMPTS}
      METRICS_AGG_PERIOD_MS: ${METRICS_AGG_PERIOD_MS}
      REPORTS_GENERATION_PERIOD_MS: ${REPORTS_GENERATION_PERIOD_MS}
      WHATSAPP_AUTOMATION_PERIOD_MS: ${WHATSAPP_AUTOMATION_PERIOD_MS}
      METRICS_BACKOFF_MS: ${METRICS_BACKOFF_MS}
      REPORT_BACKOFF_MS: ${REPORT_BACKOFF_MS}
      WHATSAPP_BACKOFF_MS: ${WHATSAPP_BACKOFF_MS}

  # -----------------------------
  # üü© SPA FRONTEND (VITE ‚Üí DIST)
  # -----------------------------
  - type: static
    name: kondor-front
    rootDir: ./front

    buildCommand: |
      npm install
      npm run build

    staticPublishPath: ./dist

    routes:
      - type: rewrite
        source: /*
        destination: /index.html

  # -----------------------------
  # üî• REDIS (BULLMQ)
  # -----------------------------
  - type: redis
    name: kondor-redis
    plan: starter
    region: oregon

# -----------------------------
# üóÑÔ∏è DATABASE (POSTGRES)
# -----------------------------
databases:
  - name: kondor-db
    region: oregon
    plan: starter
