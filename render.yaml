# ================================================
# KONDOR STUDIO ‚Äî RENDER CONFIG (API + WORKER + FRONT)
# ================================================

services:
  # -----------------------------
  # üü£ API EXPRESS (BACKEND)
  # -----------------------------
  - type: web
    name: kondor-api
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: |
      npm install
      npm run deploy:migrate

    startCommand: npm start

    envVars:
      # ---- Valores diretos ----
      - key: NODE_ENV
        value: production

      - key: PORT
        value: 4000

      # ---- DATABASE + REDIS ----
      - key: DATABASE_URL
        fromDatabase:
          name: kondor-db
          property: connectionString

      - key: REDIS_URL
        fromService:
          name: kondor-redis
          property: connectionString

      # ---- JWT ----
      - key: JWT_SECRET
        sync: false

      - key: JWT_REFRESH_SECRET
        sync: false

      # ---- CORS / URLS P√öBLICAS ----
      - key: CORS_ORIGIN
        sync: false

      - key: PUBLIC_APP_URL
        sync: false

      - key: APPROVAL_PUBLIC_LINK_TTL_HOURS
        sync: false

      # ---- S3 / STORAGE ----
      - key: S3_ENDPOINT
        sync: false

      - key: S3_BUCKET
        sync: false

      - key: S3_ACCESS_KEY_ID
        sync: false

      - key: S3_SECRET_ACCESS_KEY
        sync: false

      # ---- WHATSAPP PROVIDER ----
      - key: WHATSAPP_API_URL
        sync: false

      - key: WHATSAPP_API_KEY
        sync: false

      - key: WHATSAPP_FROM_NUMBER
        sync: false

      - key: WHATSAPP_TIMEOUT_MS
        sync: false

      # ---- M√âTRICAS META / GOOGLE ----
      - key: META_GRAPH_BASE_URL
        sync: false

      - key: META_DEFAULT_FIELDS
        sync: false

      - key: GOOGLE_ADS_API_BASE_URL
        sync: false

      - key: GOOGLE_ADS_DEFAULT_FIELDS
        sync: false

      # ---- AUDIT LOG ----
      - key: AUDIT_LOG_ENABLED
        sync: false

      - key: AUDITLOG_SKIP_REGEX
        sync: false

      - key: AUDITLOG_BODY_MAX
        sync: false

      # ---- BILLING / SUBSCRIPTION CHECK ----
      - key: CHECK_SUBSCRIPTION_ENABLED
        sync: false

      # ---- WORKERS / JOBS CONFIG (compartilhadas) ----
      - key: WORKER_POLL_INTERVAL
        sync: false

      - key: WORKER_MAX_ATTEMPTS
        sync: false

      - key: METRICS_AGG_PERIOD_MS
        sync: false

      - key: REPORTS_GENERATION_PERIOD_MS
        sync: false

      - key: WHATSAPP_AUTOMATION_PERIOD_MS
        sync: false

      - key: METRICS_BACKOFF_MS
        sync: false

      - key: REPORT_BACKOFF_MS
        sync: false

      - key: WHATSAPP_BACKOFF_MS
        sync: false

    healthCheckPath: /healthz

  # -----------------------------
  # üü° WORKER ‚Äî BULLMQ / JOBS
  # -----------------------------
  - type: worker
    name: kondor-worker
    env: node
    rootDir: ./api
    plan: starter
    region: oregon

    buildCommand: npm install
    startCommand: npm run worker

    envVars:
      # ---- Ambiente ----
      - key: NODE_ENV
        value: production

      # ---- DATABASE + REDIS ----
      - key: DATABASE_URL
        fromDatabase:
          name: kondor-db
          property: connectionString

      - key: REDIS_URL
        fromService:
          name: kondor-redis
          property: connectionString

      # ---- WORKERS / JOBS CONFIG ----
      - key: WORKER_POLL_INTERVAL
        sync: false

      - key: WORKER_MAX_ATTEMPTS
        sync: false

      - key: METRICS_AGG_PERIOD_MS
        sync: false

      - key: REPORTS_GENERATION_PERIOD_MS
        sync: false

      - key: WHATSAPP_AUTOMATION_PERIOD_MS
        sync: false

      - key: METRICS_BACKOFF_MS
        sync: false

      - key: REPORT_BACKOFF_MS
        sync: false

      - key: WHATSAPP_BACKOFF_MS
        sync: false

  # -----------------------------
  # üü© SPA FRONTEND (VITE ‚Üí DIST)
  # -----------------------------
  - type: web
    name: kondor-front
    env: node
    rootDir: ./front
    plan: starter
    region: oregon

    buildCommand: |
      npm install
      npm run build

    startCommand: |
      npm install -g serve
      serve -s dist -l 3000

    envVars:
      - key: NODE_ENV
        value: production

  # -----------------------------
  # üî• REDIS (BULLMQ)
  # -----------------------------
  - type: redis
    name: kondor-redis
    plan: starter
    region: oregon

# -----------------------------
# üóÑÔ∏è DATABASE (POSTGRES)
# -----------------------------
databases:
  - name: kondor-db
    region: oregon
    plan: starter
