generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// KONDOR STUDIO - Schema final proposto
// - Multi-tenant real
// - Billing (Plans model + Subscription + Invoice + Payment)
// - Uploads (S3) via Upload / Creative
// - Workers / Jobs persistence (IntegrationJob / JobQueue)
// - Audit log
// - Reports with relation to Upload
// - Consistent referential actions (onDelete)

// ===== ENUMS =====

enum Role {
  OWNER
  ADMIN
  MEMBER
  CLIENT
  SUPER_ADMIN
  GUEST
  SUPPORT
  FINANCE
  TECH
}

enum PostStatus {
  DRAFT
  PENDING_APPROVAL
  ARCHIVED
  SCHEDULED
  PUBLISHED
  FAILED
  CANCELLED
  IDEA
  APPROVED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum IntegrationProvider {
  META
  GOOGLE
  TIKTOK
  YOUTUBE
  WHATSAPP
  OTHER
  WHATSAPP_META_CLOUD
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  CONNECTED
  DISCONNECTED
}

enum IntegrationOwnerType {
  AGENCY
  CLIENT
}

enum DataSource {
  META_ADS
  GOOGLE_ADS
  TIKTOK_ADS
  LINKEDIN_ADS
  GA4
  GBP
  META_SOCIAL
}

enum DataSourceConnectionStatus {
  CONNECTED
  DISCONNECTED
  ERROR
}

enum MetricCatalogType {
  METRIC
  DIMENSION
}

enum ReportTemplateVisibility {
  PRIVATE
  TENANT
  PUBLIC
}

enum ReportScope {
  BRAND
  GROUP
}

enum ReportCompareMode {
  NONE
  PREVIOUS_PERIOD
  PREVIOUS_YEAR
  CUSTOM
}

enum ReportWidgetType {
  KPI
  LINE
  BAR
  PIE
  TABLE
  TEXT
  IMAGE
}

enum DashboardScope {
  BRAND
  GROUP
  TENANT
}

enum ReportExportStatus {
  PENDING
  PROCESSING
  READY
  ERROR
}

enum ReportScheduleFrequency {
  WEEKLY
  MONTHLY
}

enum BillingInterval {
  MONTHLY
  YEARLY
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SupportSeverity {
  LOW
  MEDIUM
  HIGH
}

enum TenantStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  CANCELLED
}

// ===== MODELS =====

model Tenant {
  id                String       @id @default(uuid())
  name              String
  slug              String       @unique
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  settings          Json? // branding, theme vars, tenant-specific settings
  planId            String? // default plan reference (optional)
  plan              Plan?        @relation(fields: [planId], references: [id], onDelete: SetNull)
  billingCustomerId String? // external billing customer id (Stripe/others)
  status            TenantStatus @default(TRIAL)

  // Relações 1:N
  users            User[]            @relation("TenantUsers")
  userPreferences  UserPreference[]
  teams            Team[]
  teamMembers      TeamMember[]
  clients          Client[]
  projects         Project[]
  posts            Post[]
  integrations     Integration[]
  uploads          Upload[]
  reports          Report[]
  brandGroups      BrandGroup[]
  brandGroupMembers BrandGroupMember[]
  dataSourceConnections DataSourceConnection[]
  metricCatalog    MetricCatalog[]
  reportTemplates  ReportTemplate[]
  reportWidgets    ReportWidget[]
  dashboards       Dashboard[]
  reportExports    ReportExport[]
  reportSchedules  ReportSchedule[]
  auditLogs        AuditLog[]
  subscriptions    Subscription[]
  financialRecords FinancialRecord[]
  jobQueues        JobQueue[]
  approvals        Approval[]
  tasks            Task[]
  metrics          Metric[]
  creatives        Creative[]
  competitors      Competitor[]
  competitorSnapshots CompetitorSnapshot[]
  invoices         Invoice[]
  payments         Payment[]
  jobHistory       JobHistory[]
  refreshTokens    RefreshToken[]
  systemLogs       SystemLog[]
  jobLogs          JobLog[]
  supportNotes     TenantNote[]

  createdAtIndex DateTime? @ignore

  @@index([slug])
  @@map("tenants")
}

model User {
  id            String  @id @default(uuid())
  tenantId      String
  tenant        Tenant  @relation("TenantUsers", fields: [tenantId], references: [id], onDelete: Cascade)
  email         String
  username      String?
  emailVerified Boolean @default(false)
  passwordHash  String?
  name          String?
  role          Role    @default(MEMBER)
  avatarUrl     String?
  isActive      Boolean @default(true)
  mfaEnabled    Boolean @default(false)

  refreshTokens      RefreshToken[]
  sessionTokens      SessionToken[]
  teamMemberships    TeamMember[]
  createdPosts       Post[]         @relation("AuthorPosts")
  assignedTasks      Task[]         @relation("AssigneeTasks")
  tasksCreated       Task[]         @relation("TasksCreated")
  requestedApprovals Approval[]     @relation("ApprovalRequester")
  approvalsToReview  Approval[]     @relation("ApprovalApprover")
  uploads            Upload[]
  auditLogs          AuditLog[]
  supportNotes       TenantNote[]   @relation("TenantNoteAuthor")
  mfaChallenges      MfaChallenge[]
  preferences        UserPreference[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([username])
  @@index([tenantId])
  @@map("users")
}

model UserPreference {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  postsViewMode          String?
  kanbanCollapsedColumns Json?
  lastFilters            Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@map("user_preferences")
}

model MfaChallenge {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  purpose   String   @default("admin_login")
  codeHash  String
  attempts  Int      @default(0)
  expiresAt DateTime
  usedAt    DateTime?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@map("mfa_challenges")
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId   String?
  tenant     Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  tokenHash  String
  revoked    Boolean  @default(false)
  deviceName String?
  ip         String?
  userAgent  String?
  createdAt  DateTime @default(now())
  expiresAt  DateTime

  @@index([userId])
  @@index([tenantId])
  @@index([revoked])
  @@map("refresh_tokens")
}

model SessionToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String
  meta      Json?
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
  @@index([expiresAt])
  @@map("session_tokens")
}

model Team {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  handle    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members TeamMember[]
  tasks   Task[]

  @@index([tenantId])
  @@map("teams")
}

model TeamMember {
  id             String           @id @default(uuid())
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  teamId         String
  team           Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId         String
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           Role             @default(MEMBER)
  permissions    Json? // permissões específicas por membro
  salaryCents    Int?
  salaryRecordId String?          @unique
  salaryRecord   FinancialRecord? @relation("TeamMemberSalaryRecord", fields: [salaryRecordId], references: [id], onDelete: SetNull)
  createdAt      DateTime         @default(now())

  @@unique([teamId, userId])
  @@index([tenantId])
  @@map("team_members")
}

model Client {
  id                  String    @id @default(uuid())
  tenantId            String
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name                String
  company             String?
  email               String?
  phone               String?
  sector              String?
  briefing            String?
  metadata            Json?
  contacts            Json?
  monthlyFeeCents     Int?
  renewalDate         DateTime?
  website             String?
  instagram           String?
  facebook            String?
  tiktok              String?
  tags                String[]  @default([])
  notes               String?
  logoUrl             String?
  billingContactName  String?
  billingContactEmail String?
  whatsappOptIn       Boolean   @default(false) // Cliente autorizou receber mensagens via WhatsApp
  whatsappNumberE164  String?

  // Login específico do portal do cliente
  portalEmail        String?
  portalPasswordHash String?

  projects         Project[]
  posts            Post[]
  financialRecords FinancialRecord[]
  integrations     Integration[]
  dataSourceConnections DataSourceConnection[]
  brandGroupMembers BrandGroupMember[]
  reports          Report[]
  reportSchedules  ReportSchedule[]
  dashboards       Dashboard[]
  metrics          Metric[]   @relation("ClientMetrics")
  competitors      Competitor[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([portalEmail])
  @@map("clients")
}

model Project {
  id          String  @id @default(uuid())
  tenantId    String
  tenant      Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientId    String?
  client      Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
  name        String
  description String?

  posts Post[]
  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("projects")
}

model Post {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  authorId String?
  author   User?   @relation("AuthorPosts", fields: [authorId], references: [id], onDelete: SetNull)

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  title   String
  content String? // structured content (HTML/JSON)
  caption String?

  mediaUrl  String?
  mediaType String?  @default("image")
  cta       String?
  tags      String[] @default([])

  metadata Json?

  scheduledDate DateTime?
  publishedDate DateTime?

  status     PostStatus @default(DRAFT)
  platform   String? // e.g., "instagram", "facebook"
  externalId String?    @unique // id on platform, unique when present

  clientFeedback String?
  version        Int     @default(1)
  history        Json?

  whatsappSentAt    DateTime?
  whatsappMessageId String?
  approvalLinkToken String?
  sentAt            DateTime?
  sentMethod        String?
  clientNote        String?

  createdBy String?

  metrics     Metric[]
  approvals   Approval[]
  attachments Upload[]   @relation("PostUploads")
  creatives   Creative[] @relation("PostCreatives")
  tasks       Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([scheduledDate])
  @@map("posts")
}

model Approval {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  postId   String
  post     Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  requesterId String?
  requester   User?   @relation("ApprovalRequester", fields: [requesterId], references: [id], onDelete: SetNull)

  approverId String?
  approver   User?   @relation("ApprovalApprover", fields: [approverId], references: [id], onDelete: SetNull)

  status ApprovalStatus @default(PENDING)
  notes  String?

  // Token público para acesso externo (link /public/approvals/:token)
  publicToken          String?   @unique
  publicTokenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
  @@map("approvals")
}

model Task {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  postId String?
  post   Post?   @relation(fields: [postId], references: [id], onDelete: SetNull)

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id], onDelete: SetNull)

  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?

  assigneeId String?
  assignee   User?   @relation("AssigneeTasks", fields: [assigneeId], references: [id], onDelete: SetNull)

  createdById String?
  createdBy   User?   @relation("TasksCreated", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
  @@map("tasks")
}

model Metric {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  postId      String?
  post        Post?    @relation(fields: [postId], references: [id], onDelete: SetNull)
  clientId    String?
  client      Client?  @relation("ClientMetrics", fields: [clientId], references: [id], onDelete: SetNull)
  integrationId String?
  integration Integration? @relation("IntegrationMetrics", fields: [integrationId], references: [id], onDelete: SetNull)
  name        String
  value       Float
  provider    String?
  rangeFrom   DateTime?
  rangeTo     DateTime?
  meta        Json?
  collectedAt DateTime @default(now())

  @@index([tenantId])
  @@index([postId])
  @@index([clientId])
  @@index([integrationId])
  @@index([collectedAt])
  @@map("metrics")
}

model Competitor {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  platform  String   @default("instagram")
  username  String
  name      String?
  profileUrl String?
  avatarUrl  String?
  status    String   @default("ACTIVE")
  notes     String?
  metadata  Json?

  snapshots CompetitorSnapshot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, clientId, platform, username])
  @@index([tenantId])
  @@index([clientId])
  @@index([platform])
  @@map("competitors")
}

model CompetitorSnapshot {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  competitorId String
  competitor   Competitor @relation(fields: [competitorId], references: [id], onDelete: Cascade)
  platform     String?
  followers    Int?
  postsCount   Int?
  engagementRate Float?
  interactions Int?
  likes        Int?
  comments     Int?
  rangeFrom    DateTime?
  rangeTo      DateTime?
  collectedAt  DateTime @default(now())
  meta         Json?

  @@index([tenantId])
  @@index([competitorId])
  @@index([collectedAt])
  @@map("competitor_snapshots")
}

model Creative {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  postId String?
  post   Post?   @relation("PostCreatives", fields: [postId], references: [id], onDelete: SetNull)

  uploadId String?
  upload   Upload? @relation(fields: [uploadId], references: [id], onDelete: SetNull)

  key      String // S3 key
  url      String
  filename String
  size     Int
  mimeType String
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("creatives")
}

model Upload {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  uploaderId String?
  uploader   User?   @relation(fields: [uploaderId], references: [id], onDelete: SetNull)

  key      String @unique // S3 key unique
  url      String
  filename String
  size     Int
  mimeType String
  metadata Json?
  versions Json? // optional versions / processing info

  posts     Post[]     @relation("PostUploads")
  creatives Creative[]
  reports   Report[]   @relation("ReportFiles")
  reportExports ReportExport[] @relation("ReportExportFile")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("uploads")
}

model Report {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name     String
  type     String // e.g., monthly_metrics, campaign_performance
  params   Json?
  status   String @default("pending")
  scope    ReportScope?
  brandId  String?
  brand    Client? @relation(fields: [brandId], references: [id], onDelete: SetNull)
  groupId  String?
  group    BrandGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  templateId String?
  template   ReportTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  dateFrom DateTime?
  dateTo   DateTime?
  compareMode ReportCompareMode?
  compareDateFrom DateTime?
  compareDateTo   DateTime?
  snapshotTemplate Json?

  fileId String?
  file   Upload? @relation("ReportFiles", fields: [fileId], references: [id], onDelete: SetNull)

  generatedAt DateTime?
  widgets     ReportWidget[]
  exports     ReportExport[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([brandId])
  @@index([groupId])
  @@index([templateId])
  @@map("reports")
}

model BrandGroup {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?

  members   BrandGroupMember[]
  reports   Report[]
  dashboards Dashboard[]
  reportSchedules ReportSchedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("brand_groups")
}

model BrandGroupMember {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  groupId   String
  group     BrandGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  brandId   String
  brand     Client  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([tenantId, groupId, brandId])
  @@index([tenantId])
  @@index([groupId])
  @@index([brandId])
  @@map("brand_group_members")
}

model DataSourceConnection {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  brandId   String
  brand     Client   @relation(fields: [brandId], references: [id], onDelete: Cascade)
  source    DataSource
  integrationId String?
  integration Integration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)
  externalAccountId String?
  displayName String
  status    DataSourceConnectionStatus @default(CONNECTED)
  meta      Json?

  widgets   ReportWidget[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([brandId])
  @@index([source])
  @@index([integrationId])
  @@map("data_source_connections")
}

model MetricCatalog {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  source    DataSource
  level     String
  metricKey String
  dimensionKey String?
  label     String
  type      MetricCatalogType
  supportedCharts     String[] @default([])
  supportedBreakdowns String[] @default([])
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, source, level, metricKey, type])
  @@index([tenantId])
  @@index([source])
  @@index([level])
  @@map("metric_catalog")
}

model ReportTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  visibility  ReportTemplateVisibility @default(TENANT)
  layoutSchema  Json?
  widgetsSchema Json?
  version     Int @default(1)
  parentTemplateId String?
  parentTemplate   ReportTemplate? @relation("ReportTemplateVersions", fields: [parentTemplateId], references: [id], onDelete: SetNull)
  versions    ReportTemplate[] @relation("ReportTemplateVersions")

  reports     Report[]
  reportSchedules ReportSchedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name, version])
  @@index([tenantId])
  @@map("report_templates")
}

model ReportWidget {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reportId  String
  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  widgetType ReportWidgetType
  title     String?
  source    DataSource
  connectionId String?
  connection   DataSourceConnection? @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  level     String?
  breakdown String?
  metrics   Json?
  filters   Json?
  options   Json?
  layout    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([reportId])
  @@index([source])
  @@map("report_widgets")
}

model Dashboard {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  scope     DashboardScope
  brandId   String?
  brand     Client?  @relation(fields: [brandId], references: [id], onDelete: SetNull)
  groupId   String?
  group     BrandGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  layoutSchema  Json?
  widgetsSchema Json?
  globalFiltersSchema Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope])
  @@map("dashboards")
}

model ReportExport {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reportId  String
  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  status    ReportExportStatus @default(PENDING)
  format    String @default("PDF")
  fileId    String?
  file      Upload? @relation("ReportExportFile", fields: [fileId], references: [id], onDelete: SetNull)
  meta      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([reportId])
  @@index([status])
  @@map("report_exports")
}

model ReportSchedule {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  scope     ReportScope
  brandId   String?
  brand     Client?  @relation(fields: [brandId], references: [id], onDelete: SetNull)
  groupId   String?
  group     BrandGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  templateId String?
  template   ReportTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  frequency ReportScheduleFrequency
  timezone  String @default("America/Sao_Paulo")
  scheduleConfig Json?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([scope])
  @@index([frequency])
  @@map("report_schedules")
}

model Plan {
  id          String          @id @default(uuid())
  key         String          @unique // internal key e.g. "pro_monthly"
  name        String
  description String?
  priceCents  Int             @default(0)
  currency    String          @default("BRL")
  interval    BillingInterval @default(MONTHLY)
  features    Json?
  active      Boolean         @default(true)

  tenants       Tenant[]
  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("plans")
}

model Subscription {
  id                     String        @id @default(uuid())
  tenantId               String
  tenant                 Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  planId                 String
  plan                   Plan          @relation(fields: [planId], references: [id], onDelete: Restrict)
  externalSubscriptionId String?
  status                 PaymentStatus @default(PENDING)
  currentPeriodStart     DateTime?
  currentPeriodEnd       DateTime?
  cancelAtPeriodEnd      Boolean       @default(false)

  invoices Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
  @@map("subscriptions")
}

model Invoice {
  id             String       @id @default(uuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  externalInvoiceId String?
  amountCents       Int
  currency          String        @default("BRL")
  status            PaymentStatus @default(PENDING)
  metadata          Json?
  issuedAt          DateTime?
  paidAt            DateTime?

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
  @@map("invoices")
}

model Payment {
  id        String   @id @default(uuid())
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  amountCents       Int
  currency          String        @default("BRL")
  status            PaymentStatus @default(PENDING)
  provider          String? // e.g., stripe
  providerPaymentId String?
  metadata          Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([status])
  @@map("payments")
}

model FinancialRecord {
  id               String      @id @default(uuid())
  tenantId         String
  tenant           Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  type             String // e.g., "charge", "refund", "expense"
  amountCents      Int
  currency         String      @default("BRL")
  metadata         Json?
  clientId         String?
  client           Client?     @relation(fields: [clientId], references: [id], onDelete: SetNull)
  teamMemberSalary TeamMember? @relation("TeamMemberSalaryRecord")
  note             String?
  occurredAt       DateTime    @default(now())
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([tenantId])
  @@index([clientId])
  @@map("financial_records")
}

model Integration {
  id                   String               @id @default(uuid())
  tenantId             String
  tenant               Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientId             String?
  client               Client?              @relation(fields: [clientId], references: [id], onDelete: SetNull)
  provider             IntegrationProvider
  providerName         String?
  accessToken          String? // encrypted at application level
  accessTokenEncrypted String?
  refreshToken         String?
  scopes               String[]
  settings             Json?
  config               Json?
  status               IntegrationStatus    @default(ACTIVE)
  lastError            String?
  lastSyncAt           DateTime?
  lastSyncedAt         DateTime?
  ownerType            IntegrationOwnerType @default(AGENCY)
  ownerKey             String               @default("AGENCY")

  integrationJobs IntegrationJob[]
  dataSourceConnections DataSourceConnection[]
  metrics         Metric[]   @relation("IntegrationMetrics")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, provider, ownerKey])
  @@index([tenantId])
  @@index([provider])
  @@index([ownerType, ownerKey])
  @@index([clientId])
  @@map("integrations")
}

model IntegrationJob {
  id            String      @id @default(uuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  type          String // e.g., "sync_posts", "fetch_metrics"
  status        String      @default("pending")
  payload       Json?
  result        Json?
  attempt       Int         @default(0)
  runAt         DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([integrationId])
  @@index([status])
  @@map("integration_jobs")
}

model JobQueue {
  id        String    @id @default(uuid())
  tenantId  String?
  tenant    Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  name      String // queue name
  type      String // job type
  payload   Json?
  status    String    @default("pending")
  attempts  Int       @default(0)
  runAt     DateTime?
  result    Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([tenantId])
  @@index([status])
  @@map("job_queue")
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String
  source    String
  message   String
  stack     String?
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([level])
  @@index([source])
  @@index([createdAt])
  @@map("system_logs")
}

model JobLog {
  id        String   @id @default(cuid())
  queue     String
  jobId     String?
  status    String
  attempts  Int?
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  error     String?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([queue])
  @@index([status])
  @@index([createdAt])
  @@map("job_logs")
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String
  resource   String?
  resourceId String?
  ip         String?
  meta       Json?
  createdAt  DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@map("audit_logs")
}

model TenantNote {
  id        String          @id @default(uuid())
  tenantId  String
  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  authorId  String?
  author    User?           @relation("TenantNoteAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  title     String
  body      String
  severity  SupportSeverity @default(MEDIUM)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([tenantId])
  @@index([authorId])
  @@index([severity])
  @@map("tenant_notes")
}

model JobHistory {
  id        String    @id @default(uuid())
  tenantId  String?
  tenant    Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  jobId     String
  jobType   String
  payload   Json?
  result    Json?
  status    String
  attempts  Int       @default(0)
  ranAt     DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@map("job_history")
}

model WhatsAppMessage {
  id            String   @id @default(cuid())
  tenantId      String?
  from          String
  waMessageId   String?  @unique
  phoneNumberId String?
  type          String
  textBody      String?
  rawPayload    Json
  receivedAt    DateTime @default(now())

  @@index([tenantId])
  @@index([from])
  @@map("whatsapp_messages")
}

model WhatsAppMessageLog {
  id          String   @id @default(cuid())
  tenantId    String
  waMessageId String?  @unique
  direction   String
  fromE164    String?
  toE164      String?
  payload     Json
  postId      String?
  createdAt   DateTime @default(now())

  @@index([tenantId])
}
